name: R Build and Checks

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
    paths:
      - 'R/**'
      - 'tests/**'
      - 'man/**'
      - 'DESCRIPTION'
      - 'NAMESPACE'
      - 'Dockerfile'
      - '.github/workflows/R-CMD-check.yaml'
  pull_request:
    paths:
      - 'R/**'
      - 'tests/**'
      - 'man/**'
      - 'DESCRIPTION'
      - 'NAMESPACE'
      - 'Dockerfile'
      - '.github/workflows/R-CMD-check.yaml'
  schedule:
    - cron: "0 6 10 * *"

jobs:
  # Build base image monthly (uses shared workflow from dockerDependencies)
  build-base:
    uses: GWMcElfresh/dockerDependencies/.github/workflows/build-base-image.yml@main
    permissions:
      contents: read
      packages: write
    secrets: inherit
  
  # Build and test with Docker caching (uses shared workflow from dockerDependencies)
  docker-build-and-test:
    needs: build-base
    if: always()  # Run even if base build is skipped 
    uses: GWMcElfresh/dockerDependencies/.github/workflows/docker-cache.yml@main
    with:
      r-version: '4.5'
      bioc-version: '3.21'
      use-base-image: true
      test-command: |
        Rscript -e "devtools::install_deps(dependencies = TRUE, upgrade = \"never\")" && \        
        Rscript -e "devtools::test()" && \
        R CMD build . && \
        PKG=$(ls -1t *.tar.gz | head -n1) && \
        R CMD check "$PKG" --no-manual --no-build-vignettes
      push-images: true
      push-runtime: ${{ github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
      packages: write
    secrets: inherit
