name: Python Build and Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
    paths:
      - 'python/**'
      - 'Dockerfile.python'
      - '.github/workflows/python-tests.yaml'
  pull_request:
    paths:
      - 'python/**'
      - 'Dockerfile.python'
      - '.github/workflows/python-tests.yaml'
  schedule:
    - cron: "0 6 10 * *"

jobs:
  # Build base image monthly (uses shared workflow from dockerDependencies)
  build-base:
    uses: GWMcElfresh/dockerDependencies/.github/workflows/build-base-image.yml@main
    with:
      force-rebuild: false
    permissions:
      contents: read
      packages: write
    secrets: inherit
  
  # Build and test with Docker caching
  docker-build-and-test:
    needs: build-base
    if: always()  # Run even if base build is skipped 
    uses: GWMcElfresh/dockerDependencies/.github/workflows/docker-cache.yml@main
    with:
      dockerfile-path: '.'
      context: '.'
      python-version: '3.11'
      use-base-image: true
      test-command: |
        cd /app && \
        pip install -e . && \
        python -m pytest tests/ -v --tb=short
      push-images: true
      push-runtime: ${{ github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
      packages: write
    secrets: inherit

  # Direct pytest job (without Docker) for faster feedback on PRs
  pytest:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'python/requirements.txt'
      
      - name: Install dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          cd python
          python -m pytest tests/ -v --tb=short -m "not slow"
      
      - name: Run slow tests (inference)
        if: github.event_name != 'pull_request'
        run: |
          cd python
          python -m pytest tests/ -v --tb=short -m "slow"
